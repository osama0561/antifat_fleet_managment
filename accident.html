<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetCheck - ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ø¯Ø«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [dir="rtl"] { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .photo-upload {
            border: 3px dashed #ef4444;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            min-height: 100px;
            transition: all 0.2s;
        }
        .photo-upload:hover { border-color: #dc2626; background-color: #fef2f2; }
        .photo-upload:active { transform: scale(0.98); }
        .photo-upload.has-image { border-style: solid; border-color: #10b981; border-width: 3px; }
        .doc-upload {
            border: 3px dashed #6366f1;
            cursor: pointer;
            transition: all 0.2s;
        }
        .doc-upload:hover { border-color: #4f46e5; background-color: #eef2ff; }
        .doc-upload.has-file { border-style: solid; border-color: #10b981; border-width: 3px; background-color: #ecfdf5; }
        input[type="file"] { display: none; }
        .accident-option {
            cursor: pointer;
            transition: all 0.2s;
        }
        .accident-option:hover { transform: scale(1.02); }
        .accident-option input:checked + div {
            background: #fee2e2 !important;
            border-color: #ef4444 !important;
            border-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center">
                    <span class="text-xl">ğŸš¨</span>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ø¯Ø«</h1>
                    <p class="text-xs text-gray-500">Accident Report</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="index.html" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <button id="logoutBtn" class="px-3 py-1 text-sm bg-red-100 hover:bg-red-200 text-red-700 rounded-md">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6">

        <!-- Emergency Notice -->
        <div class="bg-red-100 border-2 border-red-300 rounded-xl p-4 mb-6">
            <div class="flex items-center gap-3">
                <span class="text-3xl">âš ï¸</span>
                <div>
                    <p class="font-bold text-red-800">ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ±Ø©</p>
                    <p class="text-sm text-red-700">Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ø§Ù‹: <strong dir="ltr">911</strong></p>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>
        <div id="successMessage" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700"></div>

        <form id="accidentForm" class="bg-white rounded-xl shadow-sm p-6 space-y-6">

            <div class="border-b pb-4">
                <h2 class="text-xl font-bold text-gray-900">Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ø¯Ø«</h2>
                <p class="text-sm text-gray-600">Ø£Ø¨Ù„Øº Ø¹Ù† Ø£ÙŠ Ø­Ø§Ø¯Ø« Ù…Ø±ÙˆØ±ÙŠ Ø£Ùˆ Ø¶Ø±Ø± Ù„Ù„Ù…Ø±ÙƒØ¨Ø©</p>
            </div>

            <div id="driverSection" class="p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-600">Ø§Ù„Ø³Ø§Ø¦Ù‚:</p>
                <p id="driverName" class="font-bold text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <div id="vehicleSection" class="p-4 bg-green-50 rounded-lg">
                <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</p>
                <p id="vehicleName" class="font-bold text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <!-- ACCIDENT TYPE SELECTION -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-3">ğŸš— Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø« *</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="accident-option">
                        <input type="radio" name="accidentType" value="collision" class="hidden" required>
                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 text-center">
                            <span class="text-3xl block mb-1">ğŸ’¥</span>
                            <span class="font-semibold text-sm">ØªØµØ§Ø¯Ù…</span>
                            <span class="text-xs text-gray-500 block">Collision</span>
                        </div>
                    </label>
                    <label class="accident-option">
                        <input type="radio" name="accidentType" value="scratch" class="hidden">
                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 text-center">
                            <span class="text-3xl block mb-1">ğŸ”§</span>
                            <span class="font-semibold text-sm">Ø®Ø¯Ø´/ØµØ¯Ù…Ø©</span>
                            <span class="text-xs text-gray-500 block">Scratch/Dent</span>
                        </div>
                    </label>
                    <label class="accident-option">
                        <input type="radio" name="accidentType" value="rollover" class="hidden">
                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 text-center">
                            <span class="text-3xl block mb-1">ğŸ”„</span>
                            <span class="font-semibold text-sm">Ø§Ù†Ù‚Ù„Ø§Ø¨</span>
                            <span class="text-xs text-gray-500 block">Rollover</span>
                        </div>
                    </label>
                    <label class="accident-option">
                        <input type="radio" name="accidentType" value="hit_and_run" class="hidden">
                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 text-center">
                            <span class="text-3xl block mb-1">ğŸƒ</span>
                            <span class="font-semibold text-sm">ØµØ¯Ù… ÙˆÙ‡Ø±Ø¨</span>
                            <span class="text-xs text-gray-500 block">Hit & Run</span>
                        </div>
                    </label>
                    <label class="accident-option">
                        <input type="radio" name="accidentType" value="pedestrian" class="hidden">
                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 text-center">
                            <span class="text-3xl block mb-1">ğŸš¶</span>
                            <span class="font-semibold text-sm">Ø¯Ù‡Ø³</span>
                            <span class="text-xs text-gray-500 block">Pedestrian</span>
                        </div>
                    </label>
                    <label class="accident-option">
                        <input type="radio" name="accidentType" value="other" class="hidden">
                        <div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 text-center">
                            <span class="text-3xl block mb-1">âš™ï¸</span>
                            <span class="font-semibold text-sm">Ø£Ø®Ø±Ù‰</span>
                            <span class="text-xs text-gray-500 block">Other</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- ACCIDENT DESCRIPTION -->
            <div class="border-t pt-6">
                <label class="block text-lg font-bold text-gray-700 mb-2">ğŸ“ ÙˆØµÙ Ø§Ù„Ø­Ø§Ø¯Ø« *</label>
                <p class="text-sm text-gray-500 mb-3">Ø§Ø´Ø±Ø­ Ù…Ø§ Ø­Ø¯Ø« Ø¨Ø§Ù„ØªÙØµÙŠÙ„</p>
                <textarea id="description" rows="4" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:ring-0" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ØŒ Ù‚Ø§Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ù…Ø§Ù…ÙŠ Ø¨Ø§Ù„ÙØ±Ù…Ù„Ø© Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø©..."></textarea>
            </div>

            <!-- ACCIDENT LOCATION -->
            <div class="border-t pt-6">
                <label class="block text-lg font-bold text-gray-700 mb-2">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ø¯Ø«</label>
                <input type="text" id="accidentLocation" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ØŒ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ù…Ø­Ø·Ø© Ø£Ø±Ø§Ù…ÙƒÙˆ">
                <p id="gpsStatus" class="text-xs text-gray-500 mt-2">ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</p>
            </div>

            <!-- PHOTO CAPTURE SECTION -->
            <div class="border-t pt-6">
                <label class="block text-lg font-bold text-gray-700 mb-3">ğŸ“¸ ØµÙˆØ± Ø§Ù„Ø­Ø§Ø¯Ø« *</label>
                <p class="text-sm text-gray-500 mb-4">Ø§Ù„ØªÙ‚Ø· ØµÙˆØ± ØªÙˆØ¶Ø­ Ø§Ù„Ø£Ø¶Ø±Ø§Ø± - Ø­ØªÙ‰ 5 ØµÙˆØ±</p>
                <div class="grid grid-cols-3 gap-3">
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-3" onclick="document.getElementById('photo1').click()">
                        <input type="file" id="photo1" accept="image/*" capture="environment" onchange="handlePhoto(this, 1)">
                        <span class="text-2xl">ğŸ“·</span>
                        <span id="photo1Label" class="text-xs font-bold text-red-700 mt-1">Ø¶Ø±Ø± 1</span>
                    </div>
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-3" onclick="document.getElementById('photo2').click()">
                        <input type="file" id="photo2" accept="image/*" capture="environment" onchange="handlePhoto(this, 2)">
                        <span class="text-2xl">ğŸ“·</span>
                        <span id="photo2Label" class="text-xs font-bold text-red-700 mt-1">Ø¶Ø±Ø± 2</span>
                    </div>
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-3" onclick="document.getElementById('photo3').click()">
                        <input type="file" id="photo3" accept="image/*" capture="environment" onchange="handlePhoto(this, 3)">
                        <span class="text-2xl">ğŸ“·</span>
                        <span id="photo3Label" class="text-xs font-bold text-red-700 mt-1">Ø¶Ø±Ø± 3</span>
                    </div>
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-3" onclick="document.getElementById('photo4').click()">
                        <input type="file" id="photo4" accept="image/*" capture="environment" onchange="handlePhoto(this, 4)">
                        <span class="text-2xl">ğŸ“·</span>
                        <span id="photo4Label" class="text-xs font-bold text-red-700 mt-1">Ø¶Ø±Ø± 4</span>
                    </div>
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-3" onclick="document.getElementById('photo5').click()">
                        <input type="file" id="photo5" accept="image/*" capture="environment" onchange="handlePhoto(this, 5)">
                        <span class="text-2xl">ğŸ“·</span>
                        <span id="photo5Label" class="text-xs font-bold text-red-700 mt-1">Ø¶Ø±Ø± 5</span>
                    </div>
                </div>
            </div>

            <!-- OFFICIAL DOCUMENTS SECTION -->
            <div class="border-t pt-6">
                <label class="block text-lg font-bold text-gray-700 mb-3">ğŸ“„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©</label>
                <p class="text-sm text-gray-500 mb-4">Ø§Ø±ÙØ¹ ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ø¬Ù… Ø£Ùˆ Ø§Ù„Ø´Ø±Ø·Ø© ÙˆØªÙ‚Ø¯ÙŠØ± (ØµÙˆØ± Ø£Ùˆ PDF)</p>

                <!-- Najm Report -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="text-blue-600">1.</span> ØªÙ‚Ø±ÙŠØ± Ù†Ø¬Ù… (Najm Report)
                        <span class="text-xs text-gray-500 font-normal">- Ø£Ùˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø±Ø·Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± Ù†Ø¬Ù…</span>
                    </label>
                    <div class="doc-upload rounded-xl flex items-center justify-center p-4 gap-3" onclick="document.getElementById('najmReport').click()">
                        <input type="file" id="najmReport" accept="image/*,.pdf" onchange="handleDocument(this, 'najm')">
                        <span class="text-3xl">ğŸ“‹</span>
                        <div class="text-center">
                            <span id="najmLabel" class="text-sm font-bold text-indigo-700 block">ØªÙ‚Ø±ÙŠØ± Ù†Ø¬Ù… / Ø§Ù„Ø´Ø±Ø·Ø©</span>
                            <span class="text-xs text-gray-500">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</span>
                        </div>
                    </div>
                </div>

                <!-- Taqdir Report -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span class="text-blue-600">2.</span> ØªÙ‚Ø±ÙŠØ± ØªÙ‚Ø¯ÙŠØ± (Taqdir Report)
                        <span class="text-xs text-gray-500 font-normal">- ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø£Ø¶Ø±Ø§Ø±</span>
                    </label>
                    <div class="doc-upload rounded-xl flex items-center justify-center p-4 gap-3" onclick="document.getElementById('taqdirReport').click()">
                        <input type="file" id="taqdirReport" accept="image/*,.pdf" onchange="handleDocument(this, 'taqdir')">
                        <span class="text-3xl">ğŸ“Š</span>
                        <div class="text-center">
                            <span id="taqdirLabel" class="text-sm font-bold text-indigo-700 block">ØªÙ‚Ø±ÙŠØ± ØªÙ‚Ø¯ÙŠØ±</span>
                            <span class="text-xs text-gray-500">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</span>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-4 rounded-lg text-lg">
                Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ø¯Ø«
            </button>
        </form>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fwatvgxueajvjcwdokwh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3YXR2Z3h1ZWFqdmpjd2Rva3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTUyMTMsImV4cCI6MjA4MzI3MTIxM30.agTQDa2tEM7nvV6fzW_9K-RTK-o3vwxMatgUvuROXdA';

        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024,
            ALLOWED_IMAGE_TYPES: ['image/jpeg', 'image/jpg', 'image/png'],
            ALLOWED_DOC_TYPES: ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf']
        };

        const mySupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentDriver = null;
        let currentVehicle = null;
        let photos = { 1: null, 2: null, 3: null, 4: null, 5: null };
        let documents = { najm: null, taqdir: null };
        let currentLocation = null;

        // Get GPS location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        document.getElementById('gpsStatus').innerHTML = 'ğŸ“ <span class="text-green-600">ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© ' + Math.round(position.coords.accuracy) + ' Ù…ØªØ±</span>';
                    },
                    (error) => {
                        document.getElementById('gpsStatus').innerHTML = 'âš ï¸ <span class="text-yellow-600">ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>';
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }
        getLocation();

        async function init() {
            const { data: { session } } = await mySupabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const { data: driver } = await mySupabase
                .from('drivers')
                .select('*')
                .eq('email', session.user.email)
                .eq('is_active', true)
                .single();

            if (driver) {
                currentDriver = driver;
                document.getElementById('driverName').textContent = driver.full_name + ' (' + driver.driver_code + ')';

                const { data: assignment } = await mySupabase
                    .from('driver_vehicle_assignments')
                    .select('vehicle_id, vehicles(*)')
                    .eq('driver_id', driver.id)
                    .eq('is_current', true)
                    .single();

                if (assignment?.vehicles) {
                    currentVehicle = assignment.vehicles;
                    document.getElementById('vehicleName').textContent = currentVehicle.van_code + ' - ' + currentVehicle.plate_number;
                } else {
                    document.getElementById('vehicleName').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø© Ù…Ø®ØµØµØ©';
                }
            } else {
                document.getElementById('driverName').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚';
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await mySupabase.auth.signOut();
            window.location.href = 'login.html';
        });

        function handlePhoto(input, num) {
            const file = input.files[0];
            if (!file) return;

            if (!CONFIG.ALLOWED_IMAGE_TYPES.includes(file.type.toLowerCase())) {
                alert('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© JPG Ø£Ùˆ PNG');
                input.value = '';
                return;
            }

            if (file.size > CONFIG.MAX_FILE_SIZE) {
                alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 MB');
                input.value = '';
                return;
            }

            photos[num] = file;
            const parent = input.parentElement;
            parent.style.backgroundImage = 'url(' + URL.createObjectURL(file) + ')';
            parent.classList.add('has-image');
            document.getElementById('photo' + num + 'Label').textContent = 'âœ“ ØªÙ…';
        }

        function handleDocument(input, type) {
            const file = input.files[0];
            if (!file) return;

            if (!CONFIG.ALLOWED_DOC_TYPES.includes(file.type.toLowerCase())) {
                alert('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© JPG/PNG Ø£Ùˆ Ù…Ù„Ù PDF');
                input.value = '';
                return;
            }

            if (file.size > CONFIG.MAX_FILE_SIZE) {
                alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 MB');
                input.value = '';
                return;
            }

            documents[type] = file;
            const parent = input.parentElement;
            parent.classList.add('has-file');

            const labelId = type + 'Label';
            const fileName = file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name;
            document.getElementById(labelId).textContent = 'âœ“ ' + fileName;
        }

        async function uploadFile(file, reportCode, folder, name) {
            const fileExt = file.name.split('.').pop().toLowerCase();
            const fileName = `accidents/${reportCode}/${folder}/${name}.${fileExt}`;

            const { data, error } = await mySupabase.storage
                .from('inspections')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: true,
                    contentType: file.type
                });

            if (error) throw new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message);

            const { data: urlData } = mySupabase.storage
                .from('inspections')
                .getPublicUrl(fileName);

            return urlData.publicUrl;
        }

        document.getElementById('accidentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentDriver || !currentVehicle) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©');
                return;
            }

            // Validate accident type
            const accidentType = document.querySelector('input[name="accidentType"]:checked');
            if (!accidentType) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«');
                return;
            }

            // Validate description
            const description = document.getElementById('description').value.trim();
            if (!description) {
                alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ù„Ù„Ø­Ø§Ø¯Ø«');
                return;
            }

            // Validate at least 1 photo
            const hasPhotos = Object.values(photos).some(p => p !== null);
            if (!hasPhotos) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');

            try {
                const reportCode = 'ACC-' + Date.now();

                // Upload photos
                let photoUrls = { photo1: null, photo2: null, photo3: null, photo4: null, photo5: null };
                let uploadCount = 0;
                let totalUploads = Object.values(photos).filter(p => p).length +
                                   Object.values(documents).filter(d => d).length;

                for (let i = 1; i <= 5; i++) {
                    if (photos[i]) {
                        uploadCount++;
                        submitBtn.textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ${uploadCount}/${totalUploads}...`;
                        photoUrls['photo' + i] = await uploadFile(photos[i], reportCode, 'photos', 'damage' + i);
                    }
                }

                // Upload documents
                let docUrls = { najm: null, taqdir: null };

                if (documents.najm) {
                    uploadCount++;
                    submitBtn.textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ${uploadCount}/${totalUploads}...`;
                    docUrls.najm = await uploadFile(documents.najm, reportCode, 'docs', 'najm_report');
                }

                if (documents.taqdir) {
                    uploadCount++;
                    submitBtn.textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ${uploadCount}/${totalUploads}...`;
                    docUrls.taqdir = await uploadFile(documents.taqdir, reportCode, 'docs', 'taqdir_report');
                }

                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

                const { error: dbError } = await mySupabase.from('accident_reports').insert([{
                    report_code: reportCode,
                    driver_id: currentDriver.id,
                    vehicle_id: currentVehicle.id,
                    accident_type: accidentType.value,
                    description: description,
                    accident_location: document.getElementById('accidentLocation').value || null,
                    photo_1: photoUrls.photo1,
                    photo_2: photoUrls.photo2,
                    photo_3: photoUrls.photo3,
                    photo_4: photoUrls.photo4,
                    photo_5: photoUrls.photo5,
                    najm_report: docUrls.najm,
                    taqdir_report: docUrls.taqdir,
                    gps_latitude: currentLocation?.latitude || null,
                    gps_longitude: currentLocation?.longitude || null,
                    gps_accuracy: currentLocation?.accuracy || null,
                    status: 'pending',
                    submitted_at: new Date().toISOString()
                }]);

                if (dbError) throw dbError;

                // Update vehicle status to 'accident'
                await mySupabase
                    .from('vehicles')
                    .update({ status: 'accident' })
                    .eq('id', currentVehicle.id);

                const accidentLabels = {
                    collision: 'ØªØµØ§Ø¯Ù…', scratch: 'Ø®Ø¯Ø´/ØµØ¯Ù…Ø©', rollover: 'Ø§Ù†Ù‚Ù„Ø§Ø¨',
                    hit_and_run: 'ØµØ¯Ù… ÙˆÙ‡Ø±Ø¨', pedestrian: 'Ø¯Ù‡Ø³', other: 'Ø£Ø®Ø±Ù‰'
                };

                const photoCount = Object.values(photos).filter(p => p).length;

                document.getElementById('successMessage').innerHTML = `
                    <div class="text-center">
                        <span class="text-4xl">âœ…</span>
                        <h3 class="text-xl font-bold mt-2">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ø¯Ø«!</h3>
                        <p class="text-sm mt-2">Report Code: <strong>${reportCode}</strong></p>
                        <div class="mt-3 p-3 bg-white rounded-lg text-sm text-right">
                            <p><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${currentDriver.full_name}</p>
                            <p><strong>Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</strong> ${currentVehicle.van_code}</p>
                            <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«:</strong> ${accidentLabels[accidentType.value]}</p>
                            <p><strong>ØµÙˆØ± Ø§Ù„Ø£Ø¶Ø±Ø§Ø±:</strong> ${photoCount} ØµÙˆØ±</p>
                            <p><strong>ØªÙ‚Ø±ÙŠØ± Ù†Ø¬Ù…/Ø§Ù„Ø´Ø±Ø·Ø©:</strong> ${docUrls.najm ? 'âœ… Ù…Ø±ÙÙ‚' : 'âŒ ØºÙŠØ± Ù…Ø±ÙÙ‚'}</p>
                            <p><strong>ØªÙ‚Ø±ÙŠØ± ØªÙ‚Ø¯ÙŠØ±:</strong> ${docUrls.taqdir ? 'âœ… Ù…Ø±ÙÙ‚' : 'âŒ ØºÙŠØ± Ù…Ø±ÙÙ‚'}</p>
                        </div>
                        <p class="text-xs text-red-600 mt-3 font-bold">âš ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø¥Ù„Ù‰ "Ø­Ø§Ø¯Ø«"</p>
                        <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                    </div>
                `;
                document.getElementById('successMessage').classList.remove('hidden');

                // Reset form
                document.getElementById('accidentForm').reset();
                photos = { 1: null, 2: null, 3: null, 4: null, 5: null };
                documents = { najm: null, taqdir: null };
                document.querySelectorAll('.photo-upload').forEach(el => {
                    el.style.backgroundImage = '';
                    el.classList.remove('has-image');
                });
                document.querySelectorAll('.doc-upload').forEach(el => {
                    el.classList.remove('has-file');
                });
                document.getElementById('photo1Label').textContent = 'Ø¶Ø±Ø± 1';
                document.getElementById('photo2Label').textContent = 'Ø¶Ø±Ø± 2';
                document.getElementById('photo3Label').textContent = 'Ø¶Ø±Ø± 3';
                document.getElementById('photo4Label').textContent = 'Ø¶Ø±Ø± 4';
                document.getElementById('photo5Label').textContent = 'Ø¶Ø±Ø± 5';
                document.getElementById('najmLabel').textContent = 'ØªÙ‚Ø±ÙŠØ± Ù†Ø¬Ù… / Ø§Ù„Ø´Ø±Ø·Ø©';
                document.getElementById('taqdirLabel').textContent = 'ØªÙ‚Ø±ÙŠØ± ØªÙ‚Ø¯ÙŠØ±';

                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = 'âŒ Ø®Ø·Ø£: ' + error.message;
                document.getElementById('errorMessage').classList.remove('hidden');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ø¯Ø«';
        });

        init();
    </script>
</body>
</html>
