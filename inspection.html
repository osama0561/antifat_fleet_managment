<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetCheck - ÙØ­Øµ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [dir="rtl"] { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .photo-upload {
            border: 3px dashed #3b82f6;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            min-height: 120px;
            transition: all 0.2s;
        }
        .photo-upload:hover { border-color: #1d4ed8; background-color: #eff6ff; }
        .photo-upload:active { transform: scale(0.98); }
        .photo-upload.has-image { border-style: solid; border-color: #10b981; border-width: 3px; }
        .photo-upload .camera-icon { font-size: 2.5rem; }
        input[type="file"] { display: none; }
        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
        }
        .check-item:hover { background: #f1f5f9; }
        .check-item input[type="checkbox"] { width: 24px; height: 24px; cursor: pointer; }
        /* Inspection Type Selection */
        .inspection-type-option input:checked + div {
            background: white !important;
            color: #1d4ed8;
            border-color: white !important;
            transform: scale(1.02);
        }
        .inspection-type-option input:checked + div span:first-child {
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">FleetCheck</h1>
                    <p class="text-xs text-gray-500">Antifat Fleet Management</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="index.html" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <button id="logoutBtn" class="px-3 py-1 text-sm bg-red-100 hover:bg-red-200 text-red-700 rounded-md">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6">
        
        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700"></div>
        <div id="successMessage" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700"></div>

        <form id="inspectionForm" class="bg-white rounded-xl shadow-sm p-6 space-y-6">

            <!-- INSPECTION TYPE SELECTOR - CRITICAL -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white">
                <h2 class="text-xl font-bold text-center mb-4">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2>
                <div class="grid grid-cols-2 gap-4">
                    <label id="receiveOption" class="inspection-type-option cursor-pointer">
                        <input type="radio" name="inspectionType" value="receive" class="hidden" required>
                        <div class="bg-white/20 hover:bg-white/30 rounded-xl p-4 text-center transition-all border-2 border-transparent">
                            <span class="text-4xl block mb-2">ğŸ“¥</span>
                            <span class="text-lg font-bold block">Ø§Ø³ØªÙ„Ø§Ù…</span>
                            <span class="text-sm opacity-80">Receive Vehicle</span>
                        </div>
                    </label>
                    <label id="releaseOption" class="inspection-type-option cursor-pointer">
                        <input type="radio" name="inspectionType" value="release" class="hidden">
                        <div class="bg-white/20 hover:bg-white/30 rounded-xl p-4 text-center transition-all border-2 border-transparent">
                            <span class="text-4xl block mb-2">ğŸ“¤</span>
                            <span class="text-lg font-bold block">ØªØ³Ù„ÙŠÙ…</span>
                            <span class="text-sm opacity-80">Release Vehicle</span>
                        </div>
                    </label>
                </div>
                <p id="typeWarning" class="text-center mt-3 text-yellow-200 text-sm hidden">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
            </div>

            <div class="border-b pb-4">
                <h2 class="text-xl font-bold text-gray-900">Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h2>
                <p class="text-sm text-gray-600">ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ù† 4 Ø¬Ù‡Ø§Øª</p>
            </div>

            <div id="driverSection" class="p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-600">Ø§Ù„Ø³Ø§Ø¦Ù‚:</p>
                <p id="driverName" class="font-bold text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <div id="vehicleSection" class="p-4 bg-green-50 rounded-lg">
                <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</p>
                <p id="vehicleName" class="font-bold text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <!-- PHOTO CAPTURE SECTION -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-3">ğŸ“¸ ØµÙˆØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (4 Ø¬Ù‡Ø§Øª) *</label>
                <p class="text-sm text-gray-500 mb-4">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ø±Ø¨Ø¹ Ù„ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØªØµÙˆÙŠØ± Ù…Ø¨Ø§Ø´Ø±Ø©</p>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Front Photo -->
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-4 bg-blue-50" onclick="document.getElementById('photoFront').click()">
                        <input type="file" id="photoFront" accept="image/*" capture="environment" onchange="handlePhoto(this,'front')">
                        <span class="camera-icon">ğŸ“·</span>
                        <span id="frontLabel" class="text-sm font-bold text-blue-700 mt-2">Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©</span>
                        <span class="text-xs text-gray-500">Front</span>
                    </div>
                    <!-- Back Photo -->
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-4 bg-blue-50" onclick="document.getElementById('photoBack').click()">
                        <input type="file" id="photoBack" accept="image/*" capture="environment" onchange="handlePhoto(this,'back')">
                        <span class="camera-icon">ğŸ“·</span>
                        <span id="backLabel" class="text-sm font-bold text-blue-700 mt-2">Ø§Ù„Ø®Ù„ÙÙŠØ©</span>
                        <span class="text-xs text-gray-500">Back</span>
                    </div>
                    <!-- Right Photo -->
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-4 bg-blue-50" onclick="document.getElementById('photoRight').click()">
                        <input type="file" id="photoRight" accept="image/*" capture="environment" onchange="handlePhoto(this,'right')">
                        <span class="camera-icon">ğŸ“·</span>
                        <span id="rightLabel" class="text-sm font-bold text-blue-700 mt-2">Ø§Ù„ÙŠÙ…ÙŠÙ†</span>
                        <span class="text-xs text-gray-500">Right</span>
                    </div>
                    <!-- Left Photo -->
                    <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-4 bg-blue-50" onclick="document.getElementById('photoLeft').click()">
                        <input type="file" id="photoLeft" accept="image/*" capture="environment" onchange="handlePhoto(this,'left')">
                        <span class="camera-icon">ğŸ“·</span>
                        <span id="leftLabel" class="text-sm font-bold text-blue-700 mt-2">Ø§Ù„ÙŠØ³Ø§Ø±</span>
                        <span class="text-xs text-gray-500">Left</span>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD PHOTO -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-3">ğŸš— ØµÙˆØ±Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø¨Ù„ÙˆÙ† *</label>
                <div class="photo-upload rounded-xl flex flex-col items-center justify-center p-6 bg-yellow-50" onclick="document.getElementById('photoDashboard').click()">
                    <input type="file" id="photoDashboard" accept="image/*" capture="environment" onchange="handlePhoto(this,'dashboard')">
                    <span class="camera-icon">ğŸ“·</span>
                    <span id="dashboardLabel" class="text-sm font-bold text-yellow-700 mt-2">Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª</span>
                    <span class="text-xs text-gray-500">Dashboard / Odometer</span>
                </div>
            </div>

            <!-- LIGHTS CHECK SECTION -->
            <div class="border-t pt-6">
                <label class="block text-lg font-bold text-gray-700 mb-3">ğŸ’¡ ÙØ­Øµ Ø§Ù„Ø£Ù†ÙˆØ§Ø± *</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="check-item">
                        <input type="checkbox" id="lightFront">
                        <div>
                            <span class="font-semibold">Ø§Ù„Ø£Ù†ÙˆØ§Ø± Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©</span>
                            <span class="text-xs text-gray-500 block">Front Lights</span>
                        </div>
                    </label>
                    <label class="check-item">
                        <input type="checkbox" id="lightBack">
                        <div>
                            <span class="font-semibold">Ø§Ù„Ø£Ù†ÙˆØ§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ©</span>
                            <span class="text-xs text-gray-500 block">Back Lights</span>
                        </div>
                    </label>
                    <label class="check-item">
                        <input type="checkbox" id="signalRight">
                        <div>
                            <span class="font-semibold">Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙŠÙ…ÙŠÙ†</span>
                            <span class="text-xs text-gray-500 block">Right Signal</span>
                        </div>
                    </label>
                    <label class="check-item">
                        <input type="checkbox" id="signalLeft">
                        <div>
                            <span class="font-semibold">Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙŠØ³Ø§Ø±</span>
                            <span class="text-xs text-gray-500 block">Left Signal</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- FRIDGE/COOLER CHECK -->
            <div class="border-t pt-6">
                <label class="block text-lg font-bold text-gray-700 mb-3">â„ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ù„Ø§Ø¬Ø©/Ø§Ù„ØªØ¨Ø±ÙŠØ¯</label>
                <div class="flex gap-4">
                    <label class="check-item flex-1 justify-center">
                        <input type="radio" name="fridgeStatus" value="working" class="w-5 h-5">
                        <span class="font-semibold text-green-700">âœ… ØªØ¹Ù…Ù„</span>
                    </label>
                    <label class="check-item flex-1 justify-center">
                        <input type="radio" name="fridgeStatus" value="not_working" class="w-5 h-5">
                        <span class="font-semibold text-red-700">âŒ Ù„Ø§ ØªØ¹Ù…Ù„</span>
                    </label>
                    <label class="check-item flex-1 justify-center">
                        <input type="radio" name="fridgeStatus" value="no_fridge" class="w-5 h-5">
                        <span class="font-semibold text-gray-600">ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
                    </label>
                </div>
            </div>

            <div class="border-t border-b py-4">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="declaration" required class="mt-1 w-5 h-5">
                    <div>
                        <span class="text-sm font-semibold">Ø¥Ù‚Ø±Ø§Ø± Ø¨Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</span>
                        <p class="text-sm text-gray-600">Ø£Ù‚Ø± Ø¨Ø£Ù†Ù†ÙŠ Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø¨Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©</p>
                    </div>
                </label>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" rows="3" class="w-full px-4 py-3 border rounded-lg" maxlength="500"></textarea>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-lg">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ­Øµ
            </button>
        </form>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fwatvgxueajvjcwdokwh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3YXR2Z3h1ZWFqdmpjd2Rva3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTUyMTMsImV4cCI6MjA4MzI3MTIxM30.agTQDa2tEM7nvV6fzW_9K-RTK-o3vwxMatgUvuROXdA';

        // Configuration
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            ALLOWED_FILE_TYPES: ['image/jpeg', 'image/jpg', 'image/png'],
            MAX_IMAGE_WIDTH: 1920 // Max width for compression
        };

        const mySupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentDriver = null;
        let currentVehicle = null;
        let photos = { front: null, back: null, right: null, left: null, dashboard: null };
        let currentLocation = null;

        // Get GPS location on page load
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        console.log('ğŸ“ Location captured:', currentLocation);
                    },
                    (error) => {
                        console.warn('âš ï¸ Location error:', error.message);
                        currentLocation = null;
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }
        getLocation(); // Start getting location immediately

        async function init() {
            const { data: { session } } = await mySupabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            // Session loaded successfully
            console.log('Session loaded for:', session.user.email);

            const { data: driver } = await mySupabase
                .from('drivers')
                .select('*')
                .eq('email', session.user.email)
                .eq('is_active', true)
                .single();

            if (driver) {
                currentDriver = driver;
                document.getElementById('driverName').textContent = driver.full_name + ' (' + driver.driver_code + ')';

                const { data: assignment } = await mySupabase
                    .from('driver_vehicle_assignments')
                    .select('vehicle_id, vehicles(*)')
                    .eq('driver_id', driver.id)
                    .eq('is_current', true)
                    .single();

                if (assignment?.vehicles) {
                    currentVehicle = assignment.vehicles;
                    document.getElementById('vehicleName').textContent = currentVehicle.van_code + ' - ' + currentVehicle.plate_number;
                } else {
                    document.getElementById('vehicleName').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙƒØ¨Ø© Ù…Ø®ØµØµØ©';
                }
            } else {
                document.getElementById('driverName').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚';
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await mySupabase.auth.signOut();
            window.location.href = 'login.html';
        });

        function handlePhoto(input, side) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            if (!CONFIG.ALLOWED_FILE_TYPES.includes(file.type.toLowerCase())) {
                alert('âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© JPG Ø£Ùˆ PNG ÙÙ‚Ø·\nUnsupported file type. Please select JPG or PNG only');
                input.value = '';
                return;
            }

            // Validate file size
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                alert(`âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${sizeMB} MB). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 MB\nFile too large (${sizeMB} MB). Maximum 10 MB`);
                input.value = '';
                return;
            }

            // Store file and update UI
            photos[side] = file;
            const parent = input.parentElement;
            parent.style.backgroundImage = 'url(' + URL.createObjectURL(file) + ')';
            parent.classList.add('has-image');
            document.getElementById(side + 'Label').textContent = 'âœ“ ØªÙ…';

            console.log(`âœ… Photo selected: ${side} (${(file.size / 1024).toFixed(2)} KB)`);
        }

        // Upload photo to Supabase Storage and return public URL
        async function uploadPhoto(file, inspectionCode, side) {
            const fileExt = file.name.split('.').pop().toLowerCase();
            const fileName = `${inspectionCode}/${side}.${fileExt}`;

            // Determine content type
            const contentType = file.type || 'image/jpeg';

            console.log(`ğŸ“¤ Uploading ${side} photo (${(file.size / 1024).toFixed(2)} KB)...`);

            const { data, error } = await mySupabase.storage
                .from('inspections')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: true,
                    contentType: contentType
                });

            if (error) {
                console.error(`âŒ Upload error for ${side}:`, error);
                throw new Error(`ÙØ´Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© ${side}: ${error.message}`);
            }

            // Get public URL
            const { data: urlData } = mySupabase.storage
                .from('inspections')
                .getPublicUrl(fileName);

            console.log(`âœ… ${side} uploaded:`, urlData.publicUrl);
            return urlData.publicUrl;
        }

        document.getElementById('inspectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentDriver || !currentVehicle) {
                alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©');
                return;
            }

            // Validate inspection type (CRITICAL)
            const inspectionType = document.querySelector('input[name="inspectionType"]:checked');
            if (!inspectionType) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ ØªØ³Ù„ÙŠÙ…)');
                document.getElementById('typeWarning').classList.remove('hidden');
                return;
            }
            document.getElementById('typeWarning').classList.add('hidden');

            if (!photos.front || !photos.back || !photos.right || !photos.left || !photos.dashboard) {
                alert('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø®Ù…Ø³Ø© (4 Ø¬Ù‡Ø§Øª + Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø¨Ù„ÙˆÙ†)');
                return;
            }

            // Validate lights check
            const lightsChecked = document.getElementById('lightFront').checked &&
                                  document.getElementById('lightBack').checked &&
                                  document.getElementById('signalRight').checked &&
                                  document.getElementById('signalLeft').checked;
            if (!lightsChecked) {
                alert('ÙŠØ±Ø¬Ù‰ ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø± ÙˆØ§Ù„Ø¥Ø´Ø§Ø±Ø§Øª');
                return;
            }

            // Get fridge status
            const fridgeStatus = document.querySelector('input[name="fridgeStatus"]:checked');
            if (!fridgeStatus) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ù„Ø§Ø¬Ø©');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');

            try {
                const inspectionCode = 'INS-' + Date.now();

                // 1. Upload photos to Supabase Storage
                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© 1/5...';
                const frontUrl = await uploadPhoto(photos.front, inspectionCode, 'front');

                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© 2/5...';
                const backUrl = await uploadPhoto(photos.back, inspectionCode, 'back');

                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© 3/5...';
                const rightUrl = await uploadPhoto(photos.right, inspectionCode, 'right');

                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© 4/5...';
                const leftUrl = await uploadPhoto(photos.left, inspectionCode, 'left');

                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© 5/5...';
                const dashboardUrl = await uploadPhoto(photos.dashboard, inspectionCode, 'dashboard');

                // 2. Save to Supabase Database
                submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

                // Refresh GPS location before saving
                getLocation();

                const { error: dbError } = await mySupabase.from('inspections').insert([{
                    inspection_code: inspectionCode,
                    driver_id: currentDriver.id,
                    vehicle_id: currentVehicle.id,
                    location: currentVehicle.location,
                    inspection_type: inspectionType.value, // 'receive' or 'release'
                    photo_front: frontUrl,
                    photo_back: backUrl,
                    photo_right: rightUrl,
                    photo_left: leftUrl,
                    photo_dashboard: dashboardUrl,
                    notes: document.getElementById('notes').value || '',
                    declaration_accepted: true,
                    // New fields
                    light_front: document.getElementById('lightFront').checked,
                    light_back: document.getElementById('lightBack').checked,
                    signal_right: document.getElementById('signalRight').checked,
                    signal_left: document.getElementById('signalLeft').checked,
                    fridge_status: fridgeStatus.value,
                    gps_latitude: currentLocation?.latitude || null,
                    gps_longitude: currentLocation?.longitude || null,
                    gps_accuracy: currentLocation?.accuracy || null,
                    submitted_at: new Date().toISOString()
                }]);

                if (dbError) throw dbError;

                // Update vehicle status based on inspection type
                const newVehicleStatus = inspectionType.value === 'receive' ? 'active' : 'idle';
                const { error: vehicleError } = await mySupabase
                    .from('vehicles')
                    .update({ status: newVehicleStatus })
                    .eq('id', currentVehicle.id);

                if (vehicleError) {
                    console.warn('âš ï¸ Could not update vehicle status:', vehicleError);
                } else {
                    console.log(`âœ… Vehicle status updated to: ${newVehicleStatus}`);
                }

                console.log('âœ… Saved to database');
                console.log('ğŸ“¸ Photo URLs:', { frontUrl, backUrl, rightUrl, leftUrl, dashboardUrl });
                console.log('ğŸ“ GPS:', currentLocation);

                // Success message with inspection type
                const typeLabel = inspectionType.value === 'receive' ? 'ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù…' : 'ğŸ“¤ ØªØ³Ù„ÙŠÙ…';
                const statusLabel = inspectionType.value === 'receive' ? 'Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£ØµØ¨Ø­Øª Ù†Ø´Ø·Ø© (Active)' : 'Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø£ØµØ¨Ø­Øª Ù…ØªÙˆÙ‚ÙØ© (Idle)';

                document.getElementById('successMessage').innerHTML = `
                    <div class="text-center">
                        <span class="text-4xl">âœ…</span>
                        <h3 class="text-xl font-bold mt-2">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                        <p class="text-sm mt-2">Inspection Code: <strong>${inspectionCode}</strong></p>
                        <div class="mt-3 p-3 bg-white rounded-lg text-sm">
                            <p class="text-lg font-bold text-blue-700">${typeLabel}</p>
                            <p class="text-xs text-gray-500 mb-2">${statusLabel}</p>
                            <hr class="my-2">
                            <p><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${currentDriver.full_name}</p>
                            <p><strong>Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</strong> ${currentVehicle.van_code} - ${currentVehicle.plate_number}</p>
                            <p><strong>Ø§Ù„ØµÙˆØ±:</strong> âœ… 5 ØµÙˆØ± Ù…Ø±ÙÙˆØ¹Ø©</p>
                            <p><strong>Ø§Ù„Ø£Ù†ÙˆØ§Ø±:</strong> âœ… ØªÙ… Ø§Ù„ÙØ­Øµ</p>
                            <p><strong>Ø§Ù„Ø«Ù„Ø§Ø¬Ø©:</strong> ${fridgeStatus.value === 'working' ? 'âœ… ØªØ¹Ù…Ù„' : fridgeStatus.value === 'not_working' ? 'âŒ Ù„Ø§ ØªØ¹Ù…Ù„' : 'ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                            ${currentLocation ? `<p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ğŸ“ ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>` : ''}
                        </div>
                    </div>
                `;
                document.getElementById('successMessage').classList.remove('hidden');
                
                // Reset form
                document.getElementById('inspectionForm').reset();
                photos = { front: null, back: null, right: null, left: null, dashboard: null };
                document.querySelectorAll('.photo-upload').forEach(el => {
                    el.style.backgroundImage = '';
                    el.classList.remove('has-image');
                });
                document.getElementById('frontLabel').textContent = 'Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©';
                document.getElementById('backLabel').textContent = 'Ø§Ù„Ø®Ù„ÙÙŠØ©';
                document.getElementById('rightLabel').textContent = 'Ø§Ù„ÙŠÙ…ÙŠÙ†';
                document.getElementById('leftLabel').textContent = 'Ø§Ù„ÙŠØ³Ø§Ø±';
                document.getElementById('dashboardLabel').textContent = 'Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª';

                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('âŒ Error:', error);
                document.getElementById('errorMessage').textContent = 'âŒ Ø®Ø·Ø£: ' + error.message;
                document.getElementById('errorMessage').classList.remove('hidden');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ­Øµ';
        });

        init();
    </script>
</body>
</html>
