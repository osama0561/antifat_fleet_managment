<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Storage Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold mb-4">Supabase Storage Configuration Test</h1>

        <div id="results" class="space-y-4"></div>

        <div class="mt-6">
            <h2 class="font-semibold mb-2">Test Image Upload:</h2>
            <input type="file" id="testFile" accept="image/*" class="mb-2">
            <button onclick="testUpload()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Upload Test Image
            </button>
        </div>

        <div id="uploadResult" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fwatvgxueajvjcwdokwh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3YXR2Z3h1ZWFqdmpjd2Rva3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTUyMTMsImV4cCI6MjA4MzI3MTIxM30.agTQDa2tEM7nvV6fzW_9K-RTK-o3vwxMatgUvuROXdA';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<p class="text-gray-600">Running tests...</p>';

            let output = '';

            // Test 1: List all buckets
            output += '<div class="border-l-4 border-blue-500 pl-4 mb-4">';
            output += '<h3 class="font-semibold">Test 1: List All Buckets</h3>';
            try {
                const { data: buckets, error } = await supabase.storage.listBuckets();

                if (error) {
                    output += `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
                } else {
                    output += `<p class="text-green-600">‚úÖ Found ${buckets.length} bucket(s):</p>`;
                    output += '<ul class="list-disc ml-6">';
                    buckets.forEach(bucket => {
                        output += `<li><strong>${bucket.name}</strong> (${bucket.public ? 'Public' : 'Private'})</li>`;
                    });
                    output += '</ul>';
                }
            } catch (err) {
                output += `<p class="text-red-600">‚ùå Exception: ${err.message}</p>`;
            }
            output += '</div>';

            // Test 2: Check 'inspections' bucket
            output += '<div class="border-l-4 border-blue-500 pl-4 mb-4">';
            output += '<h3 class="font-semibold">Test 2: Check "inspections" Bucket</h3>';
            try {
                const { data: files, error } = await supabase.storage
                    .from('inspections')
                    .list('', { limit: 10 });

                if (error) {
                    output += `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
                    if (error.message.includes('not found')) {
                        output += '<p class="text-yellow-600">‚ö†Ô∏è Bucket "inspections" does not exist. You need to create it in Supabase Dashboard.</p>';
                    }
                } else {
                    output += `<p class="text-green-600">‚úÖ Bucket "inspections" exists!</p>`;
                    if (files.length === 0) {
                        output += '<p class="text-gray-600">üìÅ Bucket is empty (no files yet)</p>';
                    } else {
                        output += `<p class="text-gray-600">üìÅ Found ${files.length} file(s):</p>`;
                        output += '<ul class="list-disc ml-6">';
                        files.forEach(file => {
                            output += `<li>${file.name}</li>`;
                        });
                        output += '</ul>';
                    }
                }
            } catch (err) {
                output += `<p class="text-red-600">‚ùå Exception: ${err.message}</p>`;
            }
            output += '</div>';

            // Test 3: Check bucket public URL
            output += '<div class="border-l-4 border-blue-500 pl-4 mb-4">';
            output += '<h3 class="font-semibold">Test 3: Check Public URL Access</h3>';
            try {
                const { data } = supabase.storage
                    .from('inspections')
                    .getPublicUrl('test.jpg');

                output += `<p class="text-green-600">‚úÖ Public URL format:</p>`;
                output += `<code class="text-xs bg-gray-100 p-2 block rounded">${data.publicUrl}</code>`;
                output += '<p class="text-gray-600 text-sm mt-2">Note: This URL won\'t work until you upload a file named "test.jpg"</p>';
            } catch (err) {
                output += `<p class="text-red-600">‚ùå Exception: ${err.message}</p>`;
            }
            output += '</div>';

            results.innerHTML = output;
        }

        async function testUpload() {
            const fileInput = document.getElementById('testFile');
            const resultDiv = document.getElementById('uploadResult');

            if (!fileInput.files || !fileInput.files[0]) {
                resultDiv.innerHTML = '<p class="text-red-600">Please select a file first</p>';
                return;
            }

            const file = fileInput.files[0];
            resultDiv.innerHTML = '<p class="text-gray-600">Uploading...</p>';

            try {
                const fileName = `TEST-${Date.now()}/test-image.jpg`;

                console.log('Uploading file:', fileName);

                // Upload to Supabase Storage
                const { data, error } = await supabase.storage
                    .from('inspections')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (error) {
                    resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 p-4 rounded">
                        <p class="text-red-700 font-semibold">‚ùå Upload Failed</p>
                        <p class="text-sm text-red-600">${error.message}</p>
                    </div>`;
                    console.error('Upload error:', error);
                    return;
                }

                console.log('Upload success:', data);

                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('inspections')
                    .getPublicUrl(fileName);

                resultDiv.innerHTML = `<div class="bg-green-50 border border-green-200 p-4 rounded">
                    <p class="text-green-700 font-semibold">‚úÖ Upload Successful!</p>
                    <p class="text-sm text-gray-600 mt-2">Path: ${data.path}</p>
                    <p class="text-sm text-gray-600 mt-2">Public URL:</p>
                    <a href="${urlData.publicUrl}" target="_blank" class="text-blue-600 text-xs break-all hover:underline">${urlData.publicUrl}</a>
                    <div class="mt-4">
                        <img src="${urlData.publicUrl}" alt="Uploaded" class="max-w-sm rounded shadow">
                    </div>
                </div>`;

                // Refresh the test results
                runTests();

            } catch (err) {
                resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 p-4 rounded">
                    <p class="text-red-700 font-semibold">‚ùå Exception</p>
                    <p class="text-sm text-red-600">${err.message}</p>
                </div>`;
                console.error('Exception:', err);
            }
        }

        // Run tests on load
        runTests();
    </script>
</body>
</html>